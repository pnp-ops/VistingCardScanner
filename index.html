<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Universal Visiting Card OCR Scanner</title>
  <link rel="manifest" href="manifest.json" />
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #fff;
    }
    .container {
      max-width: 500px;
      margin: auto;
      padding: 16px;
    }
    h2 {
      text-align: center;
      color: #38bdf8;
    }
    video, canvas, img {
      width: 100%;
      border-radius: 12px;
      margin-top: 10px;
    }
    button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      background: #2563eb;
      color: white;
      cursor: pointer;
    }
    input {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border-radius: 8px;
      border: 1px solid #334155;
      background: #020617;
      color: #fff;
    }
    .status {
      text-align: center;
      margin-top: 10px;
      font-size: 14px;
      color: #94a3b8;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Universal Visiting Card Scanner</h2>

    <video id="video" autoplay playsinline></video>
    <button onclick="captureImage()">Capture Card</button>
    <input type="file" accept="image/*" onchange="uploadImage(event)" />

    <canvas id="canvas" style="display:none;"></canvas>
    <img id="preview" />

    <div class="status" id="status">Ready to scan...</div>

    <input id="name" placeholder="Name" />
    <input id="company" placeholder="Company / Hospital" />
    <input id="designation" placeholder="Designation" />
    <input id="mobile" placeholder="Mobile" />
    <input id="email" placeholder="Email" />
    <input id="website" placeholder="Website" />

    <button onclick="submitToSheet()">Submit to Google Sheet</button>
  </div>

<script>
let stream;
const GOOGLE_SCRIPT_URL = "https://script.google.com/a/macros/1mg.com/s/AKfycbzcPmeMEi0N-nnZHWrk3O9ouosrxnsPC18lSc07iPwDTi5nRw56xQfTGT_U6s0iiBvrFw/exec"; // ðŸ”´ Replace this

// Start Back Camera (Mobile Optimized)
async function startCamera() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" } },
      audio: false
    });
    document.getElementById("video").srcObject = stream;
  } catch (err) {
    document.getElementById("status").innerText = "Camera access denied or not supported.";
  }
}
startCamera();

function captureImage() {
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);

  const imageData = canvas.toDataURL("image/png");
  document.getElementById("preview").src = imageData;
  runOCR(canvas);
}

function uploadImage(event) {
  const file = event.target.files[0];
  if (!file) return;
  const img = document.getElementById("preview");
  img.src = URL.createObjectURL(file);
  img.onload = () => runOCR(img);
}

async function runOCR(image) {
  document.getElementById("status").innerText = "Scanning card... Improving OCR accuracy";

  const { data: { text } } = await Tesseract.recognize(image, "eng", {
    logger: m => console.log(m)
  });

  parseDetails(text);
  document.getElementById("status").innerText = "Scan completed âœ”";
}

function parseDetails(text) {
  const lines = text.split("\n").map(l => l.trim()).filter(l => l.length > 2);

  const emailMatch = text.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-z]{2,}/i);
  const phoneMatch = text.match(/(\+?\d[\d\s\-()]{8,18}\d)/);
  const websiteMatch = text.match(/(www\.[^\s]+|https?:\/\/[^\s]+)/i);

  document.getElementById("email").value = emailMatch ? emailMatch[0] : "";
  document.getElementById("mobile").value = phoneMatch ? phoneMatch[0].replace(/[^\d+]/g, '') : "";
  document.getElementById("website").value = websiteMatch ? websiteMatch[0] : "";

  // Doctor + Universal Name Detection (Medical Bias Added but not restricted)
  let name = lines.find(l => /^(dr\.?\s)/i.test(l) || /(MBBS|MD|MS|DM|DNB)/i.test(l));
  if (name) name = name.replace(/,?\s*(MBBS|MD|MS|DM|DNB).*$/i, "");
  if (!name) name = lines.find(l => /^[A-Z][a-z]+\s[A-Z][a-z]+/.test(l));
  if (!name) name = lines[0] || "";
  document.getElementById("name").value = name;

  // Company Detection (Hospital + Corporate)
  let company = lines.find(l =>
    /hospital|clinic|healthcare|labs|diagnostics|pharma|ltd|pvt|inc|technologies|solutions|company|group/i.test(l)
  );
  document.getElementById("company").value = company || "";

  // Designation Detection
  let designation = lines.find(l =>
    /doctor|cardiologist|manager|director|engineer|consultant|sales|marketing|ceo|founder|head/i.test(l)
  );
  document.getElementById("designation").value = designation || "";
}

// Duplicate Check + Google Sheet Sync
async function submitToSheet() {
  const data = {
    name: document.getElementById("name").value,
    company: document.getElementById("company").value,
    designation: document.getElementById("designation").value,
    mobile: document.getElementById("mobile").value,
    email: document.getElementById("email").value,
    website: document.getElementById("website").value
  };

  if (!data.mobile && !data.email) {
    alert("Mobile or Email required to avoid duplicates.");
    return;
  }

  document.getElementById("status").innerText = "Syncing to Google Sheet...";

  try {
    const res = await fetch(GOOGLE_SCRIPT_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    document.getElementById("status").innerText = "Saved to Google Sheet âœ”";
    alert("Data synced to Google Sheet successfully!");
  } catch (error) {
    document.getElementById("status").innerText = "Sync failed. Check script URL.";
    alert("Google Sheet sync failed.");
  }
}
</script>
</body>
</html>
