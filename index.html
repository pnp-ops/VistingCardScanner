<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visiting Card OCR Scanner</title>

<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#0f172a;
  color:white;
}
.container{
  max-width:500px;
  margin:auto;
  padding:16px;
}
button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:10px;
  border:none;
  background:#2563eb;
  color:white;
  font-size:16px;
}
input{
  width:100%;
  padding:10px;
  margin-top:8px;
  border-radius:8px;
  border:1px solid #334155;
  background:#020617;
  color:white;
}
#cameraSection{
  display:none;
}
#video{
  width:100%;
  border-radius:12px;
}
#status{
  margin-top:10px;
}
</style>
</head>

<body>
<div class="container">

<h2>Visiting Card Scanner</h2>

<button onclick="openCamera()">ðŸ“· Scan Card</button>
<input type="file" accept="image/*" onchange="uploadImage(event)">

<div id="cameraSection">
  <video id="video" playsinline></video>
  <button onclick="captureImage()">Capture</button>
  <button onclick="closeCamera()">Close</button>
</div>

<canvas id="canvas" style="display:none;"></canvas>
<img id="preview" width="100%">

<div id="status">Ready...</div>

<input id="name" placeholder="Name">
<input id="company" placeholder="Company">
<input id="designation" placeholder="Designation">
<input id="mobile" placeholder="Mobile">
<input id="email" placeholder="Email">
<input id="website" placeholder="Website">

<button onclick="submitToSheet()">Save to Google Sheet</button>

</div>

<script>

let stream;
const GOOGLE_SCRIPT_URL = "https://script.google.com/a/macros/1mg.com/s/AKfycbzcPmeMEi0N-nnZHWrk3O9ouosrxnsPC18lSc07iPwDTi5nRw56xQfTGT_U6s0iiBvrFw/exec";

/* ================= CAMERA ================= */

async function openCamera(){
  document.getElementById("cameraSection").style.display="block";
  stream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode:"environment"}
  });
  video.srcObject=stream;
  video.play();
}

function closeCamera(){
  if(stream) stream.getTracks().forEach(track=>track.stop());
  document.getElementById("cameraSection").style.display="none";
}

function captureImage(){
  const canvas=document.getElementById("canvas");
  const ctx=canvas.getContext("2d");

  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  ctx.drawImage(video,0,0);

  closeCamera();
  processImage(canvas);
}

/* ================= UPLOAD ================= */

function uploadImage(event){
  const file=event.target.files[0];
  if(!file) return;

  const img=new Image();
  img.onload=function(){
    const canvas=document.getElementById("canvas");
    const ctx=canvas.getContext("2d");

    canvas.width=img.width;
    canvas.height=img.height;
    ctx.drawImage(img,0,0);

    processImage(canvas);
  };
  img.src=URL.createObjectURL(file);
}

/* ================= IMAGE PROCESS ================= */

function processImage(canvas){

  const ctx=canvas.getContext("2d");
  let imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
  let data=imgData.data;

  let contrast=40;
  let factor=(259*(contrast+255))/(255*(259-contrast));

  for(let i=0;i<data.length;i+=4){
    data[i]=factor*(data[i]-128)+128;
    data[i+1]=factor*(data[i+1]-128)+128;
    data[i+2]=factor*(data[i+2]-128)+128;
  }

  ctx.putImageData(imgData,0,0);

  if(canvas.height>canvas.width){
    let temp=document.createElement("canvas");
    temp.width=canvas.height;
    temp.height=canvas.width;

    let tctx=temp.getContext("2d");
    tctx.translate(temp.width/2,temp.height/2);
    tctx.rotate(90*Math.PI/180);
    tctx.drawImage(canvas,-canvas.width/2,-canvas.height/2);

    canvas.width=temp.width;
    canvas.height=temp.height;
    ctx.drawImage(temp,0,0);
  }

  preview.src=canvas.toDataURL("image/png");
  runOCR(canvas);
}

/* ================= OCR ================= */

async function runOCR(image){

  status.innerText="Scanning...";

  const {data:{text}} = await Tesseract.recognize(image,"eng",{
    tessedit_char_whitelist:
    "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789@.+-()/,:& "
  });

  parseDetails(text);
  status.innerText="Scan Complete âœ”";
}

/* ================= SMART EXTRACTION ================= */

function parseDetails(text){

  text=text.replace(/\r/g,"");

  const lines=text
    .split("\n")
    .map(l=>l.trim())
    .filter(l=>l.length>2);

  /* EMAIL */
  const emailMatch=text.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
  email.value=emailMatch?emailMatch[0]:"";

  /* MOBILE */
  const phoneMatch=text.match(/(\+91[\s-]?\d{10}|\b\d{10}\b)/);
  mobile.value=phoneMatch?phoneMatch[0].replace(/\D/g,""):"";

  /* WEBSITE */
  const websiteMatch=text.match(/(www\.[^\s]+|https?:\/\/[^\s]+)/i);
  website.value=websiteMatch?websiteMatch[0]:"";

  /* DESIGNATION */
  const desigKeywords=["manager","director","executive","sales","business","vice","president","account","area","head","officer"];

  let detectedDesignation=lines.find(l=>
    desigKeywords.some(k=>l.toLowerCase().includes(k))
  );

  designation.value=detectedDesignation||"";

  /* NAME (line above designation) */

  let detectedName="";

  if(detectedDesignation){
    const index=lines.indexOf(detectedDesignation);
    if(index>0){
      const candidate=lines[index-1];
      if(!candidate.match(/\d|@|www|pharma|limited|ltd|pvt/i)){
        detectedName=candidate;
      }
    }
  }

  if(!detectedName){
    detectedName=lines.find(l=>
      /^[A-Z][a-z]+(\s[A-Z][a-z]+)+$/.test(l)
    );
  }

  name.value=detectedName||"";

  /* COMPANY */

  const compKeywords=["pharma","pharmaceutical","healthcare","laboratories","limited","pvt","ltd","india","solutions","oncology"];

  let detectedCompany=lines.find(l=>
    compKeywords.some(k=>l.toLowerCase().includes(k))
  );

  company.value=detectedCompany||"";
}

/* ================= GOOGLE SHEET ================= */

async function submitToSheet(){

  const data={
    name:name.value,
    company:company.value,
    designation:designation.value,
    mobile:mobile.value,
    email:email.value,
    website:website.value
  };

  if(!data.mobile && !data.email){
    alert("Mobile or Email required.");
    return;
  }

  status.innerText="Checking duplicate...";

  const check=await fetch(
    GOOGLE_SCRIPT_URL+`?mobile=${data.mobile}&email=${data.email}`
  );

  const result=await check.text();

  if(result==="DUPLICATE"){
    alert("Duplicate record found!");
    status.innerText="Duplicate.";
    return;
  }

  status.innerText="Saving...";

  await fetch(GOOGLE_SCRIPT_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(data)
  });

  alert("Saved Successfully âœ”");
  status.innerText="Saved âœ”";
}

/* ================= SERVICE WORKER ================= */

if("serviceWorker" in navigator){
  navigator.serviceWorker.register("./service-worker.js");
}

</script>

</body>
</html>
